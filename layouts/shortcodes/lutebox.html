<div class="lutebox">
  <button class="lutebox__btn">Open a Letter</button>
  <button class="lutebox__burn" title="Reset view">Reset</button>
  <p class="lutebox__hint" aria-live="polite">A sealed letter awaits you.</p>

  <div class="lutebox__result" hidden>
    <p class="lutebox__rarity"></p>
    <h3 class="lutebox__title"></h3>
    <p class="lutebox__meta"></p>
    <pre class="lutebox__body"></pre>
  </div>

  <div class="lutebox__actions" hidden>
    <button class="lutebox__retry">Try again</button>
  </div>
</div>

<style>
.lutebox{ text-align:center; margin:3rem auto; padding:2rem; background:#1c1a17; color:#f7e9c1; max-width:680px; border-radius:10px; box-shadow:0 0 20px rgba(0,0,0,.4); font-family:'EB Garamond',serif }
.lutebox__btn,.lutebox__retry,.lutebox__burn{ background:#d4af37; border:none; color:#000; font-weight:700; border-radius:8px; padding:.7rem 1.1rem; cursor:pointer }
.lutebox__burn{ margin-left:.5rem; background:#a33; color:#fff }
.lutebox__actions{ margin-top:.75rem; display:flex; gap:.5rem; justify-content:center }
.lutebox__result{ text-align:left; margin-top:1.25rem; padding:1rem; background:#2a2622; border-radius:8px }
.lutebox__meta{ opacity:.78; margin:.25rem 0; font-size:.9rem } .lutebox__body{ white-space:pre-wrap }
.lutebox__rarity{ text-transform:uppercase; font-weight:800; letter-spacing:.06em; margin:0 0 .5rem 0 }
.rarity--common{color:#b7b7b7}.rarity--uncommon{color:#6ec27a}.rarity--reallyuncommon{color:#5dc0ba}.rarity--rare{color:#58a6ff}.rarity--ultrarare{color:#c084f5}.rarity--reallyultrarare{color:#f59e0b}.rarity--legendary{color:#ffd700}
</style>

<script>
(() => {
  // No cooldown. Uses /static/lootbox/pools/letters.json at this URL:
  const PATH = '/lootbox/pools/letters.json';

  // Find UI near this script
  let probe = document.currentScript?.previousElementSibling;
  while (probe && !probe.classList?.contains('lutebox')) probe = probe.previousElementSibling;
  const box    = probe || document.querySelector('.lutebox'); if (!box) return;
  const BTN    = box.querySelector('.lutebox__btn');
  const BURN   = box.querySelector('.lutebox__burn');
  const HINT   = box.querySelector('.lutebox__hint');
  const RESULT = box.querySelector('.lutebox__result');
  const ACTIONS= box.querySelector('.lutebox__actions');
  const RETRY  = box.querySelector('.lutebox__retry');
  const RARITY = box.querySelector('.lutebox__rarity');
  const TITLE  = box.querySelector('.lutebox__title');
  const META   = box.querySelector('.lutebox__meta');
  const BODY   = box.querySelector('.lutebox__body');

  const RARITY_META = {
    common:{label:"Common",stars:1},
    uncommon:{label:"Uncommon",stars:2},
    reallyuncommon:{label:"Really Uncommon",stars:3},
    rare:{label:"Rare",stars:4},
    ultrarare:{label:"Ultrarare",stars:5},
    reallyultrarare:{label:"Really Ultrarare",stars:6},
    legendary:{label:"Legendary",stars:7}
  };
  const normalize = r => String(r||'').toLowerCase();
  const starLine  = n => (n<=5 ? '★'.repeat(n)+'☆'.repeat(5-n) : '★'.repeat(n)) + ` (${Math.min(n,5)}/5)`;

  let ITEMS = [], ODDS = {};

  function resetBox(){
    HINT.textContent = 'A sealed letter awaits you.';
    RESULT.hidden = true; ACTIONS.hidden = true;
    [TITLE,META,BODY].forEach(el => el.textContent='');
    RARITY.textContent=''; RARITY.className='lutebox__rarity';
    BTN.disabled = false;
  }
  function setNoOpen(){
    HINT.textContent = 'Could not open letter.';
    ACTIONS.hidden = false; BTN.disabled = false;
  }
  function setLoadError(){
    HINT.textContent = 'Could not load letters.'; ACTIONS.hidden = false; BTN.disabled = false;
  }

  async function ensurePool(){
    if (ITEMS.length) return true;
    try{
      const pool = await fetch(PATH, {cache:'no-store'}).then(r => r.json());
      ITEMS = Array.isArray(pool.items) ? pool.items : [];
      ODDS  = pool.odds || {};
      return ITEMS.length > 0;
    }catch(e){
      console.error('[Lutebox] load error:', e);
      return false;
    }
  }

  function pick(items, odds){
    if (!items.length) return {kind:'empty'};

    // Build buckets for known rarities
    const buckets = {};
    let total = 0;
    const weights = [];

    for (const key of Object.keys(RARITY_META)){
      const bucket = items.filter(i => normalize(i.rarity) === key);
      buckets[key] = bucket;
      const w = Number(odds?.[key] || 0);
      if (bucket.length && w > 0){ weights.push([key, w]); total += w; }
    }

    // Respect noopen probability if provided
    const noOpenW = Number(odds?.noopen || 0);
    if (noOpenW > 0){ weights.push(['__noopen__', noOpenW]); total += noOpenW; }

    // If no weights configured, fall back to uniform from all items
    if (total <= 0){
      return {kind:'item', item: items[Math.floor(Math.random()*items.length)]};
    }

    let roll = Math.random() * total;
    for (const [k,w] of weights){
      roll -= w;
      if (roll <= 0){
        if (k === '__noopen__') return {kind:'noopen'};
        const b = buckets[k].length ? buckets[k] : items;
        return {kind:'item', item: b[Math.floor(Math.random()*b.length)]};
      }
    }
    return {kind:'item', item: items[Math.floor(Math.random()*items.length)]};
  }

  function render(item){
    const rk   = normalize(item.rarity);
    const meta = RARITY_META[rk] || RARITY_META.common;
    TITLE.textContent = item.title || '(Untitled Letter)';
    const bits = [];
    if (item.meta?.date) bits.push(item.meta.date);
    if (item.meta?.factions?.length) bits.push(item.meta.factions.join(' · '));
    if (item.meta?.voices?.length) bits.push('Voices: ' + item.meta.voices.join(', '));
    META.textContent = bits.join(' — ');
    BODY.textContent = (item.body || '').trim();
    RARITY.textContent = `${meta.label} — ${starLine(meta.stars)}`;
    RARITY.className = `lutebox__rarity rarity--${rk}`;
    RESULT.hidden = false; ACTIONS.hidden = true; HINT.textContent = 'Open another?';
  }

  async function openLetter(){
    BTN.disabled = true; ACTIONS.hidden = true; HINT.textContent = 'Opening...';
    try{
      const ok = await ensurePool();
      if (!ok) { setLoadError(); return; }
      const res = pick(ITEMS, ODDS);
      if (res.kind === 'noopen') { setNoOpen(); return; }
      if (res.kind === 'empty' || !res.item) { setLoadError(); return; }
      render(res.item);
    }catch(e){
      console.error('[Lutebox] open error:', e);
      setLoadError();
    }finally{
      BTN.disabled = false;
    }
  }

  BTN.addEventListener('click', openLetter);
  RETRY.addEventListener('click', openLetter);
  BURN.addEventListener('click', resetBox);
  resetBox();
})();
</script>
