<div class="lutebox">
  <button class="lutebox__btn">Open a Letter</button>
  <button class="lutebox__burn" title="Reset to a fresh page state">Burn</button>
  <p class="lutebox__hint" aria-live="polite">A sealed letter awaits you.</p>

  <div class="lutebox__result" hidden>
    <p class="lutebox__rarity"></p>
    <h3 class="lutebox__title"></h3>
    <p class="lutebox__meta"></p>
    <pre class="lutebox__body"></pre>
  </div>

  <div class="lutebox__actions" hidden>
    <button class="lutebox__retry">Use a letter-opener</button>
  </div>
</div>

<style>
.lutebox{ text-align:center; margin:3rem auto; padding:2rem; background:#1c1a17; color:#f7e9c1; max-width:640px; border-radius:10px; box-shadow:0 0 20px rgba(0,0,0,.4); font-family:'EB Garamond',serif }
.lutebox__btn,.lutebox__retry,.lutebox__burn{ background:#d4af37; border:none; color:#000; font-weight:700; border-radius:8px; padding:.7rem 1.1rem; cursor:pointer }
.lutebox__burn{ margin-left:.5rem; background:#a33; color:#fff }
.lutebox__actions{ margin-top:.75rem; display:flex; gap:.5rem; justify-content:center }
.lutebox__result{ text-align:left; margin-top:1.25rem; padding:1rem; background:#2a2622; border-radius:8px }
.lutebox__meta{ opacity:.78; margin:.25rem 0; font-size:.9rem } .lutebox__body{ white-space:pre-wrap }
.lutebox__rarity{ text-transform:uppercase; font-weight:800; letter-spacing:.06em; margin:0 0 .5rem 0 }
.rarity--common{color:#b7b7b7}.rarity--uncommon{color:#6ec27a}.rarity--reallyuncommon{color:#5dc0ba}.rarity--rare{color:#58a6ff}.rarity--ultrarare{color:#c084f5}.rarity--reallyultrarare{color:#f59e0b}.rarity--legendary{color:#ffd700}
</style>

{{/* Inline from data/lutebox/pools/letters.json (no fetch) */}}
{{- $pool := .Site.Data.lutebox.pools.letters | default (dict "items" (slice) "odds" (dict)) -}}

<script>
(() => {
  // JSON inlined at build time from data/lutebox/pools/letters.json
  const POOL  = {{ $pool | jsonify | safeJS }};
  const ITEMS = Array.isArray(POOL.items) ? POOL.items : [];
  const ODDS  = POOL.odds || {};

  // Minimal DOM refs (script must be directly after the .lutebox block)
  let probe = document.currentScript?.previousElementSibling;
  while (probe && !probe.classList?.contains('lutebox')) probe = probe.previousElementSibling;
  const box    = probe || document.querySelector('.lutebox'); if (!box) return;
  const BTN    = box.querySelector('.lutebox__btn');
  const BURN   = box.querySelector('.lutebox__burn');
  const HINT   = box.querySelector('.lutebox__hint');
  const RESULT = box.querySelector('.lutebox__result');
  const ACTIONS= box.querySelector('.lutebox__actions');
  const RETRY  = box.querySelector('.lutebox__retry');
  const RARITY = box.querySelector('.lutebox__rarity');
  const TITLE  = box.querySelector('.lutebox__title');
  const META   = box.querySelector('.lutebox__meta');
  const BODY   = box.querySelector('.lutebox__body');

  // Rarity map (includes reallyultrarare) — unchanged keys
  const RARITY_META = {
    common:{label:"Common",stars:1},
    uncommon:{label:"Uncommon",stars:2},
    reallyuncommon:{label:"Really Uncommon",stars:3},
    rare:{label:"Rare",stars:4},
    ultrarare:{label:"Ultrarare",stars:5},
    reallyultrarare:{label:"Really Ultrarare",stars:6},
    legendary:{label:"Legendary",stars:7}
  };
  const normalize = r => {
    const k = String(r || '').toLowerCase();
    return Object.prototype.hasOwnProperty.call(RARITY_META, k) ? k : 'common';
  };

  // === Stars: fixed /5 display; still shows 6/5 and 7/5 ===
const RARITY_MAX = Math.max(...Object.values(RARITY_META).map(x => x.stars));
const starLine = (n) => {
  const filled = Math.max(0, Math.min(Number(n) || 0, 7)); // clamp 0..7
  if (filled >= 5) {
    // Hidden tiers (and 5/5): no hollow stars
    return '★'.repeat(filled) + ` (${filled}/5)`;
  } else {
    // Show hollows up to 5 only
    return '★'.repeat(filled) + '☆'.repeat(5 - filled) + ` (${filled}/5)`;
  }
};

  // Minimal confetti for top tiers (no CSS deps, self-removing)
  function confettiBurst(){
    const container = document.createElement('div');
    container.style.position = 'fixed';
    container.style.inset = '0';
    container.style.pointerEvents = 'none';
    container.style.zIndex = '9999';
    document.body.appendChild(container);

    const N = 40;
    for (let i=0; i<N; i++){
      const d = document.createElement('div');
      const size = 5 + Math.random()*6;
      d.style.position = 'absolute';
      d.style.left = (Math.random()*100) + 'vw';
      d.style.top = '-12px';
      d.style.width = size + 'px';
      d.style.height = (size*0.45) + 'px';
      d.style.background = `hsl(${Math.floor(Math.random()*360)},80%,60%)`;
      d.style.opacity = '0.9';
      container.appendChild(d);

      const drift = (Math.random() - 0.5) * 160;
      const spin  = 360 + Math.random()*360;
      const dur   = 1200 + Math.random()*900;
      d.animate(
        [
          { transform: 'translate(0,0) rotate(0deg)',   offset: 0   },
          { transform: `translate(${drift/2}px,55vh) rotate(${spin/2}deg)`, offset: 0.6 },
          { transform: `translate(${drift}px,100vh) rotate(${spin}deg)`,    offset: 1   }
        ],
        { duration: dur, easing: 'cubic-bezier(.2,.7,.2,1)', fill: 'forwards' }
      );
    }
    setTimeout(() => container.remove(), 2200);
  }

  function resetBox(){
    HINT.textContent = 'A sealed letter awaits you.';
    RESULT.hidden = true; ACTIONS.hidden = true;
    [TITLE,META,BODY].forEach(el => el.textContent='');
    RARITY.textContent=''; RARITY.className='lutebox__rarity';
    BTN.disabled = false;
  }
  function setNoOpen(){
    HINT.textContent = 'Could not open letter.';
    ACTIONS.hidden = false;
    BTN.disabled = false;
  }

  // Weighted pick with odds.noopen support — unchanged
  function pick(items, odds){
    const buckets = {};
    const weights = [];
    let total = 0;

    for (const key of Object.keys(RARITY_META)){
      const bucket = items.filter(i => normalize(i.rarity) === key);
      buckets[key] = bucket;
      const w = bucket.length ? Number(odds?.[key] || 0) : 0;
      if (w > 0){ weights.push([key, w]); total += w; }
    }
    const noOpenW = Number(odds?.noopen || 0);
    if (noOpenW > 0){ weights.push(['__noopen__', noOpenW]); total += noOpenW; }

    if (total <= 0){
      if (!items.length) return { kind:'noopen' };
      return { kind:'item', item: items[Math.floor(Math.random()*items.length)] };
    }

    let roll = Math.random() * total;
    for (const [k,w] of weights){
      roll -= w;
      if (roll <= 0){
        if (k === '__noopen__') return { kind:'noopen' };
        const b = buckets[k].length ? buckets[k] : items;
        return { kind:'item', item: b[Math.floor(Math.random()*b.length)] };
      }
    }
    return { kind:'item', item: items[Math.floor(Math.random()*items.length)] };
  }

function render(item){
  const rk   = normalize(item.rarity);
  const meta = RARITY_META[rk];

  TITLE.textContent = item.title || '(Untitled Letter)';

  const bits = [];
  if (item.meta?.date) bits.push(item.meta.date);
  if (item.meta?.factions?.length) bits.push(item.meta.factions.join(' · '));
  if (item.meta?.voices?.length) bits.push('Voices: ' + item.meta.voices.join(', '));
  META.textContent = bits.join(' — ');

  BODY.textContent = (item.body || '').trim();

  // ALWAYS show the label + stars
  RARITY.innerHTML = `<span class="rarity__label">${meta.label}</span> — <span class="rarity__stars">${starLine(meta.stars)}</span>`;
  RARITY.className = `lutebox__rarity rarity--${rk}`;

  RESULT.hidden = false; ACTIONS.hidden = true; HINT.textContent = 'Open another?';
  
    // Tiny confetti for 6/5 and 7/5
    if (meta.stars >= 6) confettiBurst();
  }

  function openLetter(){
    BTN.disabled = true; ACTIONS.hidden = true;
    HINT.textContent = 'Opening...';
    try{
      if (!ITEMS.length) { setNoOpen(); return; }
      const res = pick(ITEMS, ODDS);
      if (res.kind === 'noopen') { setNoOpen(); return; }
      render(res.item);
    } finally {
      BTN.disabled = false;
    }
  }

  BTN.addEventListener('click', openLetter);
  RETRY.addEventListener('click', openLetter);
  BURN.addEventListener('click', resetBox);

  resetBox();
})();
</script>
