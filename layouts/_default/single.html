<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>{{ .Title }} – {{ .Site.Title }}</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="/style.css">
  </head>
  <body>
    <header>
      <h1><a href="/">{{ .Site.Title }}</a></h1>
    </header>

    <main>
      <h2>{{ .Title }}</h2>

      {{ with .Params.image }}
        <img src="{{ . }}" alt="{{ $.Title }}">
      {{ end }}

      <article>
        {{ .Content }}
      </article>

      {{/* -------- Robust prev/next -------- */}}
      {{- $cur := . -}}
      {{- $all := where site.RegularPages "Kind" "page" -}}
      {{- $all = where $all "Section" "ne" "lutebox" -}}
      {{- $all = sort $all "Date" "asc" "Title" "asc" -}}

      {{- /* Find the first index whose Permalink matches the current page */ -}}
      {{- $idx := -1 -}}
      {{- range $i, $p := $all -}}
        {{- if eq $p.Permalink $cur.Permalink -}}
          {{- $idx = $i -}}
          {{- break -}}
        {{- end -}}
      {{- end -}}

      {{- /* Compute previous (skip duplicates that equal current) */ -}}
      {{- $prev := nil -}}
      {{- if ge $idx 1 -}}
        {{- $cand := index $all (sub $idx 1) -}}
        {{- if eq $cand.Permalink $cur.Permalink -}}
          {{- if ge $idx 2 -}}
            {{- $prev = index $all (sub $idx 2) -}}
          {{- end -}}
        {{- else -}}
          {{- $prev = $cand -}}
        {{- end -}}
      {{- end -}}

      {{- /* Compute next (skip duplicates that equal current) */ -}}
      {{- $next := nil -}}
      {{- $n := len $all -}}
      {{- if lt (add $idx 1) $n -}}
        {{- $cand := index $all (add $idx 1) -}}
        {{- if eq $cand.Permalink $cur.Permalink -}}
          {{- if lt (add $idx 2) $n -}}
            {{- $next = index $all (add $idx 2) -}}
          {{- end -}}
        {{- else -}}
          {{- $next = $cand -}}
        {{- end -}}
      {{- end -}}

      <nav class="post-nav">
        <div class="nav-grid" style="display:flex;gap:1rem;justify-content:space-between">
          <div>
            {{ with $prev }}<a href="{{ .RelPermalink }}">← Previous</a>{{ end }}
          </div>
          <div><a href="{{ "/" | relURL }}">Back to Home</a></div>
          <div>
            {{ with $next }}<a href="{{ .RelPermalink }}">Next →</a>{{ end }}
          </div>
        </div>
      </nav>
      {{/* -------- /prev/next -------- */}}
    </main>
  </body>
</html>
